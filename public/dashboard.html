<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; margin: 0; color: #333; }

        .header { background: #46178f; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h2 { margin: 0; font-size: 20px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 800px; margin: 30px auto; padding: 0 15px; }

        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .btn-big { padding: 30px; border-radius: 12px; text-decoration: none; font-size: 20px; font-weight: bold; text-align: center; color: white; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .btn-big:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .create { background: linear-gradient(135deg, #28a745, #20c997); }
        .join { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #333; }

        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; font-weight: 600; color: #777; transition: 0.2s; position: relative; font-size: 16px; }
        .tab:hover { color: #46178f; }
        .tab.active { color: #46178f; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: #46178f; border-radius: 3px 3px 0 0; }

        .quiz-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .quiz-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .quiz-info strong { font-size: 18px; display: block; margin-bottom: 4px; }
        .quiz-info small { color: #888; }

        .quiz-actions { display: flex; gap: 10px; align-items: center; }

        .btn-play { background: #46178f; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-flex; align-items: center; transition: 0.2s; }
        .btn-play:hover { background: #350f6e; }

        .btn-menu { background: #f0f0f5; color: #46178f; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; padding-bottom: 10px; box-sizing: border-box; font-weight: bold;}
        .btn-menu:hover { background: #e0e0eb; }

        .menu-wrap { position: relative; }
        .dropdown { position: absolute; right: 0; top: 50px; background: white; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: none; z-index: 100; min-width: 150px; overflow: hidden; }
        .dropdown.show { display: block; }
        .dropdown-item { padding: 12px 20px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px; transition: 0.1s; }
        .dropdown-item:hover { background: #f8f9fa; }
        .text-danger { color: #d9534f; }
        .text-danger:hover { background: #fff5f5; }

        .history-item { background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .h-left { display: flex; align-items: center; gap: 15px; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; text-transform: uppercase; }
        .badge-player { background: #e91e63; }
        .badge-host { background: #46178f; }

        .h-title { font-weight: bold; font-size: 16px; }
        .h-score { font-weight: bold; color: #333; }
        .h-date { font-size: 12px; color: #999; }

    </style>
</head>
<body>

    <div class="header">
        <h2>Кабинет <span id="username">...</span></h2>
        <button onclick="logout()" class="logout-btn">Выйти</button>
    </div>

    <div class="container">
        <div class="action-buttons">
            <a href="/create.html" class="btn-big create">Создать Квиз</a>
            <a href="/player.html" class="btn-big join">Войти в игру</a>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quizzes')">Мои Квизы</div>
            <div class="tab" onclick="switchTab('history')">История игр</div>
        </div>

        <div id="tab-quizzes">
            <div id="quiz-list">Загрузка...</div>
        </div>

        <div id="tab-history" style="display: none;">
            <div id="history-list">Загрузка...</div>

            <div id="clear-history-area" style="margin-top: 20px; text-align: center; display: none;">
                <button onclick="clearHistory()" style="background-color: #ff4d4f; color: white; border: none; padding: 10px 20px; border-radius: 7px; cursor: pointer; font-weight: bold;"
                                                 onmouseover="this.style.backgroundColor='#ff3333'"
                                                 onmouseout="this.style.backgroundColor='#ff4d4f'">
                    Очистить историю
                </button>
            </div>
        </div>
    </div>

    <script>
        window.onclick = function(event) {
            if (!event.target.closest('.menu-wrap')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
            }
        }

        fetch('/api/me').then(res => {
            if (!res.ok) window.location.href = '/login.html';
            return res.json();
        }).then(user => {
            document.getElementById('username').innerText = user.username;
            loadQuizzes();
            loadHistory();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById('tab-quizzes').style.display = tabName === 'quizzes' ? 'block' : 'none';
            document.getElementById('tab-history').style.display = tabName === 'history' ? 'block' : 'none';
        }

        function loadQuizzes() {
            fetch('/api/my-quizzes').then(res => res.json()).then(quizzes => {
                const list = document.getElementById('quiz-list');
                if (quizzes.length === 0) list.innerHTML = "<p style='text-align:center; color:#777;'>У вас пока нет квизов. Создайте первый!</p>";
                else list.innerHTML = quizzes.map(q => `
                    <div class="quiz-card">
                        <div class="quiz-info">
                            <strong>${q.title}</strong>
                            <small>${q.description || ''}</small>
                        </div>
                        <div class="quiz-actions">
                            <div class="menu-wrap">
                                <button class="btn-menu" onclick="toggleMenu(${q.id})">...</button>
                                <div id="menu-${q.id}" class="dropdown">
                                    <div class="dropdown-item" onclick="editQuiz(${q.id})">Изменить</div>
                                    <div class="dropdown-item text-danger" onclick="deleteQuiz(${q.id})">Удалить</div>
                                </div>
                            </div>
                            <a href="/host.html?quizId=${q.id}" class="btn-play">Запустить</a>
                        </div>
                    </div>`).join('');
            });
        }

        function toggleMenu(id) {
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d.id !== `menu-${id}`) d.classList.remove('show');
            });
            document.getElementById(`menu-${id}`).classList.toggle('show');
        }

        function deleteQuiz(id) {
            if(!confirm("Вы уверены, что хотите удалить этот квиз безвозвратно?")) return;
            fetch(`/api/quizzes/${id}`, { method: 'DELETE' }).then(res => {
                if(res.ok) loadQuizzes();
                else alert("Ошибка удаления");
            });
        }

        function editQuiz(id) {
            window.location.href = `/create.html?id=${id}`;
        }

        function loadHistory() {
            fetch('/api/my-history').then(res => res.json()).then(rows => {
                const list = document.getElementById('history-list');
                const clearBtnArea = document.getElementById('clear-history-area');

                if (rows.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#777;'>История пуста</p>";
                    clearBtnArea.style.display = 'none';
                } else {
                    clearBtnArea.style.display = 'block';
                        list.innerHTML = rows.map(r => {
                        const isHost = r.role === 'host';
                        const badgeClass = isHost ? 'badge-host' : 'badge-player';
                        const roleText = isHost ? 'Ведущий' : 'Участник';
                        const details = isHost ? '' : `— ${r.score} очков`;

                        return `
                        <div class="history-item">
                            <div class="h-left">
                                <span class="badge ${badgeClass}">${roleText}</span>
                                <span class="h-title">${r.quiz_title} ${details}</span>
                            </div>
                            <div class="h-date">${r.date}</div>
                        </div>`;
                    }).join('');
                }
            });
        }

        async function clearHistory() {
            if (!confirm("Вы уверены, что хотите удалить всю историю игр?")) {
                return;
            }

            try {
                const response = await fetch('/api/my-history', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const historyContainer = document.getElementById('history-list');
                    if (historyContainer) {
                        historyContainer.innerHTML = '<p style="text-align:center; color: #777;">История пуста</p>';
                    }
                    alert("История очищена!");

                    window.location.reload();
                } else {
                    alert("Ошибка при удалении.");
                }
            } catch (error) {
                console.error(error);
                alert("Ошибка соединения с сервером.");
            }
        }

        function logout() { fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/login.html'); }
    </script>
</body>
</html>
