<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ведущий</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #46178f; }
        .quiz-card { border: 2px solid #eee; padding: 20px; margin: 15px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .quiz-card:hover { border-color: #46178f; background-color: #f9f9ff; }

        #lobby-screen, #question-screen, #game-over-screen { display: none; }

        .big-pin { font-size: 60px; font-weight: 900; color: #46178f; letter-spacing: 5px; margin: 20px 0; }

        .timer-container { width: 100%; height: 30px; background-color: #ddd; border-radius: 15px; margin-bottom: 20px; overflow: hidden; }
        .timer-bar { height: 100%; width: 100%; background-color: #46178f; transform-origin: left; }

        .animate-timer { animation-name: countdown; animation-timing-function: linear; animation-fill-mode: forwards; }
        @keyframes countdown { from { width: 100%; background-color: #46178f; } to { width: 0%; background-color: #e21b3c; } }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .option-box { padding: 30px; color: white; font-size: 24px; font-weight: bold; border-radius: 10px; }

        .gold { background: #ffd700; color: #000; padding: 10px; margin: 5px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div id="selection-screen">
            <h1>Выберите квиз</h1>
            <div id="quiz-list">Загрузка...</div>
        </div>

        <div id="lobby-screen">
            <h1>Код игры:</h1>
            <div id="game-pin" class="big-pin">...</div>
            <div id="players-list">Пока никого нет...</div>

            <div style="margin: 20px; padding: 10px; background: #eee; display: inline-block; border-radius: 10px;">
                <input type="checkbox" id="auto-move-check" onchange="toggleAuto()">
                <label for="auto-move-check" style="font-size: 18px; cursor:pointer;">Авто-переключение вопросов</label>
            </div>
            <br>
            <button onclick="startGame()" style="background:#28a745; color:white; padding:15px 40px; font-size:24px; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">НАЧАТЬ</button>
        </div>

        <div id="question-screen">
            <div class="timer-container"><div id="timer-bar" class="timer-bar"></div></div>
            <h3 id="q-counter" style="color:#888;">Вопрос...</h3>

            <div id="image-container" style="height: 250px; margin: 10px auto; display: none;">
                <img id="q-image" src="" style="max-height: 100%; max-width: 100%; border-radius: 10px;">
            </div>

            <h1 id="q-text">...</h1>
            <div id="options-container" class="options-grid"></div>

            <button id="next-btn" onclick="nextQuestion()" style="margin-top: 40px; padding: 15px 30px; font-size: 20px; background: #333; color: white; border: none; cursor: pointer; border-radius: 5px;">Следующий вопрос</button>
        </div>

        <div id="game-over-screen">
            <h1>Результаты</h1>
            <div id="leaderboard"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPin = '';
        let myDbId = null;

        fetch('/api/me')
            .then(res => {
                if (!res.ok) {
                    alert("Сначала нужно войти!");
                    window.location.href = '/login.html';
                    throw new Error("Not authorized");
                }
                return res.json();
            })
            .then(user => {
                myDbId = user.id;

                const urlParams = new URLSearchParams(window.location.search);
                const autoStartId = urlParams.get('quizId');

                if (autoStartId) {
                    console.log("Автозапуск квиза ID:", autoStartId);
                    socket.emit('host_init_game', { quizId: autoStartId, hostDbId: myDbId });
                    document.getElementById('selection-screen').style.display = 'none';
                } else {
                    loadQuizzes();
                }
            })
            .catch(err => console.error(err));

        function loadQuizzes() {
            document.getElementById('selection-screen').style.display = 'block';
            fetch('/api/my-quizzes').then(res => res.json()).then(quizzes => {
                const list = document.getElementById('quiz-list');
                list.innerHTML = '';
                if (quizzes.length === 0) list.innerHTML = "<p>Нет квизов</p>";

                quizzes.forEach(quiz => {
                    const div = document.createElement('div');
                    div.className = 'quiz-card';
                    div.innerHTML = `<h3>${quiz.title}</h3>`;
                    div.onclick = () => {
                        socket.emit('host_init_game', { quizId: quiz.id, hostDbId: myDbId });
                    };
                    list.appendChild(div);
                });
            });
        }



        socket.on('game_created', (data) => {
            currentPin = data.pin;
            const selScreen = document.getElementById('selection-screen');
            if(selScreen) selScreen.style.display = 'none';

            document.getElementById('lobby-screen').style.display = 'block';
            document.getElementById('game-pin').innerText = data.pin;
        });

        socket.on('update_player_list', (players) => {
            document.getElementById('players-list').innerHTML = players.map(p => `<span>${p.name}, </span>`).join('');
        });

        function toggleAuto() {
            const isChecked = document.getElementById('auto-move-check').checked;
            socket.emit('host_toggle_auto', { pin: currentPin, enabled: isChecked });
        }

        function startGame() { socket.emit('host_start_game', currentPin); }
        function nextQuestion() { socket.emit('host_next_question', currentPin); }

        socket.on('new_question', (data) => {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('question-screen').style.display = 'block';

            document.getElementById('q-counter').innerText = `Вопрос ${data.current} из ${data.total}`;
            document.getElementById('q-text').innerText = data.text;

            const btn = document.getElementById('next-btn');
            if (data.current === data.total) {
                btn.innerText = "ЗАВЕРШИТЬ КВИЗ";
                btn.style.backgroundColor = "#d9534f";
            } else {
                btn.innerText = "Следующий вопрос";
                btn.style.backgroundColor = "#333";
            }

            const imgContainer = document.getElementById('image-container');
            if (data.image) {
                imgContainer.style.display = 'block';
                document.getElementById('q-image').src = data.image;
            } else {
                imgContainer.style.display = 'none';
            }

            const timer = document.getElementById('timer-bar');
            timer.classList.remove('animate-timer');
            void timer.offsetWidth;
            timer.style.animationDuration = data.timeLimit + 's';
            timer.classList.add('animate-timer');

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const colors = ['#e21b3c', '#1368ce', '#d89e00', '#26890c'];
            data.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option-box';
                div.style.backgroundColor = colors[i];
                div.innerText = opt;
                container.appendChild(div);
            });
        });



        socket.on('game_over', (leaderboard) => {
            document.getElementById('question-screen').style.display = 'none';
            const gameOverScreen = document.getElementById('game-over-screen');
            gameOverScreen.style.display = 'block';

            document.getElementById('leaderboard').innerHTML = leaderboard.map((p, i) =>
                `<div class="gold">#${i+1} ${p.name} - ${p.score}</div>`
            ).join('');

            let btnContainer = document.getElementById('final-buttons');
            if (!btnContainer) {
                btnContainer = document.createElement('div');
                btnContainer.id = 'final-buttons';
                btnContainer.style.marginTop = '20px';
                gameOverScreen.appendChild(btnContainer);
            }

            btnContainer.innerHTML = '';

            const exitBtn = document.createElement('button');
            exitBtn.innerText = "Вернуться в кабинет";
            exitBtn.onclick = () => window.location.href = '/dashboard.html';

            exitBtn.style.padding = "15px 30px";
            exitBtn.style.fontSize = "18px";
            exitBtn.style.cursor = "pointer";
            exitBtn.style.backgroundColor = "#46178f";
            exitBtn.style.color = "white";
            exitBtn.style.border = "none";
            exitBtn.style.borderRadius = "5px";

            btnContainer.appendChild(exitBtn);
        });
    </script>
</body>
</html>
